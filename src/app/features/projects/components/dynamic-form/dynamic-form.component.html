<div class="p-8 max-w-4xl mx-auto">
  <div class="bg-white rounded-xl shadow-lg p-8 border-2 border-amber-200">
    
    <!-- En-tête -->
    <div class="mb-8">
      <h1 class="text-3xl font-serif font-bold text-amber-900 mb-2">
        Formulaire des compétences
      </h1>
  
    </div>

    <!-- Formulaire -->
    <form [formGroup]="dynamicForm" (ngSubmit)="onSubmit()" class="space-y-8">
      
      <!-- Nom -->
      <div>
        <label for="nom" class="block text-sm font-sans font-medium text-stone-700 mb-2">
          Nom <span class="text-red-500">*</span>
        </label>
        <input
          type="text"
          id="nom"
          formControlName="nom"
          placeholder="Entrez votre nom"
          class="w-full px-4 py-2 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-200 focus:border-amber-600 transition duration-300"
          [class.border-red-500]="nom?.invalid && nom?.touched"
          [class.border-green-500]="nom?.valid && nom?.touched"
        />
        @if (nom?.hasError('required') && nom?.touched) {
          <p class="text-red-600 text-sm mt-1">Le nom est requis.</p>
        }
      </div>

      <!-- Section Emails (FormArray) -->
      <div class="border-t border-amber-200 pt-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-serif font-bold text-amber-900">
            Emails
          </h2>
          <button
            type="button"
            (click)="addEmail()"
            class="add-button px-4 py-2 bg-amber-700 text-white rounded-lg hover:bg-amber-800 transition duration-300 flex items-center gap-2 text-sm font-sans font-medium"
          >
            Ajouter un email
          </button>
        </div>

        <!-- FormArray des emails -->
        <div formArrayName="emails" class="space-y-4">
          @for (emailControl of emails.controls; track $index; let i = $index) {
            <div [formGroupName]="i" class="form-array-item flex gap-3 p-4 bg-amber-50 rounded-lg border border-amber-200">
              <!-- Numéro -->
              <div class="flex items-center justify-center w-8 h-8 bg-amber-700 text-white rounded-full font-sans font-bold text-sm flex-shrink-0">
                {{ i + 1 }}
              </div>

              <!-- Champ Email -->
              <div class="flex-1">
                <input
                  type="email"
                  formControlName="email"
                  placeholder="exemple@email.com"
                  class="w-full px-3 py-2 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-200 focus:border-amber-600 transition duration-300 text-sm"
                  [class.border-red-500]="getEmailAt(i).get('email')?.invalid && getEmailAt(i).get('email')?.touched"
                />
                @if (getEmailAt(i).get('email')?.hasError('required') && getEmailAt(i).get('email')?.touched) {
                  <p class="text-red-600 text-xs mt-1">Email requis</p>
                }
                @if (getEmailAt(i).get('email')?.hasError('email') && getEmailAt(i).get('email')?.touched) {
                  <p class="text-red-600 text-xs mt-1">Email invalide</p>
                }
              </div>

              <!-- Type -->
              <div class="w-40">
                <select
                  formControlName="type"
                  class="w-full px-3 py-2 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-200 focus:border-amber-600 transition duration-300 text-sm"
                >
                  @for (type of emailTypes; track type) {
                    <option [value]="type">{{ type }}</option>
                  }
                </select>
              </div>

              <!-- Bouton Supprimer -->
              <button
                type="button"
                (click)="removeEmail(i)"
                [disabled]="emails.length === 1"
                class="remove-button flex-shrink-0 px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 disabled:bg-stone-400 disabled:cursor-not-allowed transition duration-300 text-sm font-sans font-medium"
                [title]="emails.length === 1 ? 'Au moins un email est requis' : 'Supprimer cet email'"
              >
                Supprimer
              </button>
            </div>
          }
        </div>

        <p class="text-sm text-stone-600 font-sans mt-3">
          Vous pouvez ajouter plusieurs emails. Au moins un email est requis.
        </p>
      </div>

      <!-- Section Compétences (FormArray) -->
      <div class="border-t border-amber-200 pt-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-xl font-serif font-bold text-amber-900">
              Compétences
            </h2>
            @if (competences.hasError('minCompetences') && competences.touched) {
              <p class="text-red-600 text-sm mt-1 font-sans">
                Vous devez ajouter au moins {{ competences.errors?.['minCompetences']?.required }} compétences
                ({{ competences.errors?.['minCompetences']?.current }} / {{ competences.errors?.['minCompetences']?.required }})
              </p>
            }
          </div>
          <button
            type="button"
            (click)="addCompetence()"
            class="add-button px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-300 flex items-center gap-2 text-sm font-sans font-medium"
          >
            Ajouter une compétence
          </button>
        </div>

        <!-- FormArray des compétences -->
        @if (competences.length === 0) {
          <div class="p-8 text-center bg-amber-50 rounded-lg border-2 border-dashed border-amber-300">
            <p class="text-stone-600 font-sans mb-3">
              Aucune compétence ajoutée
            </p>
            <button
              type="button"
              (click)="addCompetence()"
              class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-300 text-sm font-sans font-medium"
            >
              Ajouter votre première compétence
            </button>
          </div>
        } @else {
          <div formArrayName="competences" class="space-y-4">
            @for (competenceControl of competences.controls; track $index; let i = $index) {
              <div [formGroupName]="i" class="competence-item flex gap-3 p-4 bg-gradient-to-r from-amber-50 to-green-50 rounded-lg border border-green-200">
                <!-- Numéro -->
                <div class="flex items-center justify-center w-8 h-8 bg-green-600 text-white rounded-full font-sans font-bold text-sm flex-shrink-0">
                  {{ i + 1 }}
                </div>

                <!-- Nom de la compétence -->
                <div class="flex-1">
                  <input
                    type="text"
                    formControlName="nom"
                    placeholder="Nom de la compétence (ex: JavaScript)"
                    class="w-full px-3 py-2 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-200 focus:border-amber-600 transition duration-300 text-sm"
                    [class.border-red-500]="getCompetenceAt(i).get('nom')?.invalid && getCompetenceAt(i).get('nom')?.touched"
                  />
                  @if (getCompetenceAt(i).get('nom')?.hasError('required') && getCompetenceAt(i).get('nom')?.touched) {
                    <p class="text-red-600 text-xs mt-1 font-sans">Nom requis</p>
                  }
                </div>

                <!-- Niveau -->
                <div class="w-48">
                  <div class="flex items-center gap-2">
                    <input
                      type="range"
                      formControlName="niveau"
                      min="1"
                      max="5"
                      class="flex-1 h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer"
                    />
                    <span class="text-2xl w-20 text-center" [title]="'Niveau: ' + getCompetenceAt(i).get('niveau')?.value">
                      {{ getStarsLabel(getCompetenceAt(i).get('niveau')?.value) }}
                    </span>
                  </div>
                  <p class="text-xs text-stone-600 font-sans mt-1 text-center">
                    Niveau {{ getCompetenceAt(i).get('niveau')?.value }} / 5
                  </p>
                </div>

                <!-- Bouton Supprimer -->
                <button
                  type="button"
                  (click)="removeCompetence(i)"
                  class="remove-button flex-shrink-0 px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-300 text-sm font-sans font-medium"
                  title="Supprimer cette compétence"
                >
                  Supprimer
                </button>
              </div>
            }
          </div>
        }

        <p class="text-sm text-stone-600 font-sans mt-3">
          Si vous ajoutez des compétences, vous devez en avoir au moins 3.
        </p>
      </div>

      <!-- Boutons d'action -->
      <div class="flex flex-wrap gap-3 pt-6 border-t border-amber-200">
        <button
          type="submit"
          [disabled]="dynamicForm.invalid"
          class="flex-1 min-w-[200px] px-6 py-3 bg-amber-700 text-white rounded-lg font-sans font-medium hover:bg-amber-800 disabled:bg-stone-400 disabled:cursor-not-allowed transition duration-300 shadow-md hover:shadow-lg"
        >
          Soumettre
        </button>
        
        <button
          type="button"
          (click)="resetForm()"
          class="px-6 py-3 bg-amber-100 text-stone-700 rounded-lg font-sans font-medium hover:bg-amber-200 transition duration-300"
        >
          Réinitialiser
        </button>
      </div>

      <!-- Statut du formulaire -->
      <div class="p-4 bg-amber-50 rounded-lg border border-amber-200">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm font-sans">
          <div>
            <span class="font-medium text-stone-700">Statut :</span>
            @if (dynamicForm.valid) {
              <span class="ml-2 text-green-600 font-bold">Valide</span>
            } @else {
              <span class="ml-2 text-orange-600 font-bold">Incomplet</span>
            }
          </div>
          <div>
            <span class="font-medium text-stone-700">Emails :</span>
            <span class="ml-2 text-amber-700 font-bold">{{ emails.length }}</span>
          </div>
          <div>
            <span class="font-medium text-stone-700">Compétences :</span>
            <span class="ml-2 text-green-600 font-bold">{{ competences.length }}</span>
          </div>
          <div>
            <span class="font-medium text-stone-700">Modifié :</span>
            <span class="ml-2" [class.text-amber-700]="dynamicForm.dirty" [class.text-stone-400]="!dynamicForm.dirty">
              {{ dynamicForm.dirty ? 'Oui' : 'Non' }}
            </span>
          </div>
        </div>
      </div>
    </form>

  </div>
</div>
